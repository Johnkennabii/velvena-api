generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id          String  @id @default(uuid())
  name        String
  slug        String  @unique // URL-friendly identifier (ex: "boutique-paris")
  email       String?
  phone       String?
  address     String?
  city        String?
  postal_code String?
  country     String?
  logo_url    String?

  // Legal & Manager Information
  siret                String? // SIRET number (French business registration)
  manager_gender       String? // Mr, Mme, Mx, etc.
  manager_first_name   String? // Manager first name
  manager_last_name    String? // Manager last name
  manager_title        String? // Position title (e.g., "gérante", "gérant", "directeur")

  settings    Json? // Organization-specific settings (deprecated, use business_rules)

  // Business Rules Configuration
  business_rules Json? // Configurable business rules (pricing, services, etc.)
  /**
   * Example business_rules structure:
   * {
   * "pricing": {
   * "default_strategy": "per_day",
   * "tax_rate": 20,
   * "currency": "EUR",
   * "allow_custom_pricing": true
   * },
   * "services": {
   * "rental_types": ["short_term", "long_term", "event"],
   * "default_rental_duration": 3
   * },
   * "billing": {
   * "deposit_required": true,
   * "deposit_percentage": 30,
   * "payment_terms_days": 30
   * }
   * }
   */

  // Subscription Management
  subscription_plan_id    String? // Reference to SubscriptionPlan
  subscription_status     String    @default("trial") // trial, active, suspended, cancelled
  subscription_started_at DateTime? @default(now())
  trial_ends_at           DateTime?
  subscription_ends_at    DateTime? // For cancelled subscriptions

  // Stripe Integration
  stripe_customer_id     String? @unique // Stripe Customer ID
  stripe_subscription_id String? @unique // Stripe Subscription ID

  // Deprecated - use subscription_plan_id instead
  subscription_plan String? @default("free") // free, basic, pro, enterprise

  // Usage & Quotas (cached for performance)
  current_usage Json? // Cached usage counts
  /**
   * Example:
   * {
   * "users": 5,
   * "dresses": 120,
   * "customers": 89,
   * "contracts_this_month": 12,
   * "last_updated": "2025-12-06T10:00:00Z"
   * }
   */

  is_active  Boolean   @default(true)
  created_at DateTime  @default(now())
  created_by String?
  updated_at DateTime? @updatedAt
  updated_by String?
  deleted_at DateTime?
  deleted_by String?

  // Relations
  users     User[]
  dresses   Dress[]
  customers Customer[]
  prospects Prospect[]
  contracts Contract[]

  // Reference data (organization-specific)
  dress_types        DressType[]
  dress_sizes        DressSize[]
  dress_colors       DressColor[]
  dress_conditions   DressCondition[]
  contract_templates ContractTemplate[]
  contract_packages  ContractPackage[]
  contract_addons    ContractAddon[]
  pricing_rules      PricingRule[]

  // Subscription & Usage
  subscription SubscriptionPlan? @relation(fields: [subscription_plan_id], references: [id])
  usage_events UsageEvent[]

  @@index([slug])
  @@index([is_active])
  @@index([subscription_plan_id])
  @@index([subscription_status])
  @@index([stripe_customer_id])
  @@index([stripe_subscription_id])
}

model User {
  id                 String                 @id @default(uuid())
  email              String                 @unique
  password           String
  organization_id    String
  created_at         DateTime               @default(now())
  created_by         String?
  deleted_at         DateTime?
  deleted_by         String?
  last_signin_at     DateTime?
  raw_user_meta_data Json?
  updated_at         DateTime?              @updatedAt
  updated_by         String?

  // Email verification
  email_verified                      Boolean   @default(false)
  email_verification_token            String?   @unique
  email_verification_token_expires_at DateTime?

  organization       Organization           @relation(fields: [organization_id], references: [id])
  profile            Profile?
  notifications      NotificationUserLink[]

  @@index([organization_id])
  @@index([email_verification_token])
}

model Profile {
  id          String    @id @default(uuid())
  firstName   String?
  lastName    String?
  userId      String    @unique
  address     String?
  avatar_url  String?
  city        String?
  country     String?
  created_at  DateTime  @default(now())
  created_by  String?
  deleted_at  DateTime?
  deleted_by  String?
  postal_code String?
  role_id     String?
  updated_at  DateTime? @updatedAt
  updated_by  String?
  user_layout Json?
  role        Role?     @relation(fields: [role_id], references: [id])
  user        User      @relation(fields: [userId], references: [id])
}

model Role {
  id          String    @id @default(uuid())
  name        String    @unique // Nom unique global
  description String?
  created_at  DateTime  @default(now())
  created_by  String?
  updated_at  DateTime? @updatedAt
  updated_by  String?
  deleted_at  DateTime?
  deleted_by  String?

  // Relations
  profiles Profile[]
}

model DressType {
  id              String        @id @default(uuid())
  name            String
  organization_id String? // null = global (shared across all orgs)
  description     String?
  created_at      DateTime      @default(now())
  created_by      String?
  updated_at      DateTime?     @updatedAt
  updated_by      String?
  deleted_at      DateTime?
  deleted_by      String?
  organization    Organization? @relation(fields: [organization_id], references: [id])
  dresses         Dress[]

  @@unique([name, organization_id]) // Unique per organization
  @@index([organization_id])
}

model DressSize {
  id              String        @id @default(uuid())
  name            String
  organization_id String? // null = global (shared across all orgs)
  created_at      DateTime      @default(now())
  created_by      String?
  updated_at      DateTime?     @updatedAt
  updated_by      String?
  deleted_at      DateTime?
  deleted_by      String?
  organization    Organization? @relation(fields: [organization_id], references: [id])
  dresses         Dress[]

  @@unique([name, organization_id]) // Unique per organization
  @@index([organization_id])
}

model DressCondition {
  id              String        @id @default(uuid())
  name            String
  organization_id String? // null = global (shared across all orgs)
  created_at      DateTime      @default(now())
  created_by      String?
  updated_at      DateTime?     @updatedAt
  updated_by      String?
  deleted_at      DateTime?
  deleted_by      String?
  organization    Organization? @relation(fields: [organization_id], references: [id])
  dresses         Dress[]

  @@unique([name, organization_id]) // Unique per organization
  @@index([organization_id])
}

model DressColor {
  id              String        @id @default(uuid())
  name            String
  hex_code        String
  organization_id String? // null = global (shared across all orgs)
  created_at      DateTime      @default(now())
  created_by      String?
  updated_at      DateTime?     @updatedAt
  updated_by      String?
  deleted_at      DateTime?
  deleted_by      String?
  organization    Organization? @relation(fields: [organization_id], references: [id])
  dresses         Dress[]

  @@unique([name, organization_id]) // Unique per organization
  @@unique([hex_code, organization_id]) // Unique per organization
  @@index([organization_id])
}

model Dress {
  id                       String                     @id @default(uuid())
  name                     String
  reference                String
  organization_id          String
  price_ht                 Decimal
  price_ttc                Decimal
  images                   String[]
  created_at               DateTime                   @default(now())
  created_by               String?
  updated_at               DateTime?                  @updatedAt
  updated_by               String?
  deleted_at               DateTime?
  deleted_by               String?
  published_at             DateTime?
  published_by             String?
  published_post           Boolean                    @default(false)
  type_id                  String?
  size_id                  String?
  condition_id             String?
  color_id                 String?
  price_per_day_ht         Decimal
  price_per_day_ttc        Decimal
  organization             Organization               @relation(fields: [organization_id], references: [id])
  ContractDress            ContractDress[]
  prospect_reservations    ProspectDressReservation[]
  prospect_request_dresses ProspectRequestDress[]
  color                    DressColor?                @relation(fields: [color_id], references: [id])
  condition                DressCondition?            @relation(fields: [condition_id], references: [id])
  size                     DressSize?                 @relation(fields: [size_id], references: [id])
  type                     DressType?                 @relation(fields: [type_id], references: [id])

  @@unique([reference, organization_id]) // Reference unique per organization
  @@index([organization_id])
}

model Customer {
  id              String             @id @default(uuid())
  firstname       String
  lastname        String
  email           String
  organization_id String
  phone           String?
  birthday        DateTime?
  country         String?
  city            String?
  address         String?
  postal_code     String?
  created_by      String?
  created_at      DateTime           @default(now())
  updated_at      DateTime?          @updatedAt
  updated_by      String?
  deleted_at      DateTime?
  deleted_by      String?
  organization    Organization       @relation(fields: [organization_id], references: [id])
  contracts       Contract[]
  sign_links      ContractSignLink[]
  notes           CustomerNote[]

  @@unique([email, organization_id]) // Email unique per organization
  @@index([organization_id])
}

model Prospect {
  id                 String                     @id @default(uuid())
  firstname          String
  lastname           String
  email              String
  organization_id    String
  phone              String?
  birthday           DateTime?
  country            String?
  city               String?
  address            String?
  postal_code        String?
  status             String                     @default("new")
  source             String?
  notes              String?
  created_by         String?
  created_at         DateTime                   @default(now())
  updated_at         DateTime?                  @updatedAt
  updated_by         String?
  deleted_at         DateTime?
  deleted_by         String?
  converted_at       DateTime?
  converted_by       String?
  converted_to       String?
  organization       Organization               @relation(fields: [organization_id], references: [id])
  dress_reservations ProspectDressReservation[]
  requests           ProspectRequest[]

  @@unique([email, organization_id]) // Email unique per organization
  @@index([organization_id])
}

model ProspectDressReservation {
  id                String    @id @default(uuid())
  prospect_id       String
  dress_id          String
  rental_start_date DateTime
  rental_end_date   DateTime
  notes             String?
  created_at        DateTime  @default(now())
  created_by        String?
  updated_at        DateTime? @updatedAt
  updated_by        String?
  deleted_at        DateTime?
  deleted_by        String?

  prospect Prospect @relation(fields: [prospect_id], references: [id], onDelete: Cascade)
  dress    Dress    @relation(fields: [dress_id], references: [id], onDelete: Cascade)

  @@index([prospect_id])
  @@index([dress_id])
  @@index([rental_start_date, rental_end_date])
}

model ProspectRequest {
  id                  String    @id @default(uuid())
  request_number      String    @unique
  prospect_id         String
  status              String    @default("draft") // draft, sent, confirmed, cancelled
  total_estimated_ht  Decimal   @default(0)
  total_estimated_ttc Decimal   @default(0)
  notes               String?
  created_at          DateTime  @default(now())
  created_by          String?
  updated_at          DateTime? @updatedAt
  updated_by          String?
  deleted_at          DateTime?
  deleted_by          String?

  prospect Prospect               @relation(fields: [prospect_id], references: [id], onDelete: Cascade)
  dresses  ProspectRequestDress[]

  @@index([prospect_id])
  @@index([request_number])
}

model ProspectRequestDress {
  id                  String    @id @default(uuid())
  request_id          String
  dress_id            String
  rental_start_date   DateTime
  rental_end_date     DateTime
  rental_days         Int
  estimated_price_ht  Decimal   @default(0)
  estimated_price_ttc Decimal   @default(0)
  notes               String?
  created_at          DateTime  @default(now())
  created_by          String?
  updated_at          DateTime? @updatedAt
  updated_by          String?
  deleted_at          DateTime?
  deleted_by          String?

  request ProspectRequest @relation(fields: [request_id], references: [id], onDelete: Cascade)
  dress   Dress           @relation(fields: [dress_id], references: [id], onDelete: Cascade)

  @@index([request_id])
  @@index([dress_id])
  @@index([rental_start_date, rental_end_date])
}

model ContractType {
  id   String @id @default(uuid())
  name String @unique // Nom unique global

  // Configuration métier (anciennement dans ServiceType)
  config Json? // Configuration pour ce type de contrat
  /**
   * Example config:
   * {
   *   "min_duration_days": 1,
   *   "max_duration_days": 7,
   *   "requires_deposit": true,
   *   "default_deposit_percentage": 30,
   *   "description": "Location courte durée avec caution"
   * }
   */

  created_at DateTime  @default(now())
  created_by String?
  updated_at DateTime? @updatedAt
  updated_by String?
  deleted_at DateTime?
  deleted_by String?

  // Relations
  contracts     Contract[]
  templates     ContractTemplate[] // Templates liés à ce type
  pricing_rules PricingRule[]      // Règles de tarification pour ce type
}

model ContractTemplate {
  id               String        @id @default(uuid())
  name             String // "Contrat Négafa Standard", "Contrat Location Simple"
  description      String? // Description du template
  contract_type_id String // Lien obligatoire avec un type de contrat
  organization_id  String? // null = template global (disponible pour tous)

  // Contenu du template
  content          String?       @db.Text // HTML avec {{variables}} (legacy, optionnel)
  structure        Json? // Structure JSON du template (nouveau système)
  html_cache       String?       @db.Text // HTML généré (cache pour performance)

  // Métadonnées
  is_active        Boolean       @default(true)
  is_default       Boolean       @default(false) // Template par défaut pour ce type/org
  version          Int           @default(1)

  created_at       DateTime      @default(now())
  created_by       String?
  updated_at       DateTime?     @updatedAt
  updated_by       String?
  deleted_at       DateTime?
  deleted_by       String?

  // Relations
  contract_type    ContractType  @relation(fields: [contract_type_id], references: [id], onDelete: Cascade)
  organization     Organization? @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  contracts        Contract[]    @relation("ContractToTemplate")

  // Note: La contrainte d'unicité pour is_default sera gérée par une migration SQL manuelle
  // car Prisma ne supporte pas les index partiels (WHERE is_default = true)
  @@index([organization_id])
  @@index([contract_type_id])
  @@index([is_active])
  @@index([contract_type_id, organization_id, is_default])
}

model ContractPackage {
  id              String         @id @default(uuid())
  name            String
  organization_id String? // null = global (shared across all orgs)
  num_dresses     Int
  price_ht        Decimal
  price_ttc       Decimal
  created_at      DateTime       @default(now())
  created_by      String?
  updated_at      DateTime?      @updatedAt
  updated_by      String?
  deleted_at      DateTime?
  deleted_by      String?
  organization    Organization?  @relation(fields: [organization_id], references: [id])
  contracts       Contract[]
  addons          PackageAddon[]

  @@unique([name, organization_id]) // Unique per organization
  @@index([organization_id])
}

model ContractAddon {
  id              String              @id @default(uuid())
  name            String
  organization_id String? // null = global (shared across all orgs)
  description     String?
  price_ht        Decimal             @default(0)
  price_ttc       Decimal             @default(0)
  included        Boolean             @default(false)
  created_at      DateTime            @default(now())
  created_by      String?
  updated_at      DateTime?           @updatedAt
  updated_by      String?
  deleted_at      DateTime?
  deleted_by      String?
  organization    Organization?       @relation(fields: [organization_id], references: [id])
  contract_links  ContractAddonLink[]
  packages        PackageAddon[]

  @@unique([name, organization_id]) // Unique per organization
  @@index([organization_id])
}

model Contract {
  id                     String              @id @default(uuid())
  contract_number        String
  organization_id        String
  customer_id            String
  start_datetime         DateTime
  end_datetime           DateTime
  account_ht             Decimal
  account_ttc            Decimal
  account_paid_ht        Decimal
  account_paid_ttc       Decimal
  caution_ht             Decimal
  caution_ttc            Decimal
  caution_paid_ht        Decimal
  caution_paid_ttc       Decimal
  total_price_ht         Decimal
  total_price_ttc        Decimal
  deposit_payment_method String
  status                 String
  contract_type_id       String
  package_id             String?
  template_id            String? // Référence au template utilisé
  rendered_template      String?             @db.Text // HTML généré à partir du template
  created_at             DateTime            @default(now())
  created_by             String?
  updated_at             DateTime?           @updatedAt
  updated_by             String?
  deleted_at             DateTime?
  deleted_by             String?
  signed_at              DateTime?
  signed_pdf_url         String?
  signature_ip           String?
  signature_location     String?
  signature_reference    String?
  organization           Organization         @relation(fields: [organization_id], references: [id])
  contract_type          ContractType         @relation(fields: [contract_type_id], references: [id])
  customer               Customer             @relation(fields: [customer_id], references: [id])
  package                ContractPackage?     @relation(fields: [package_id], references: [id])
  template               ContractTemplate?    @relation("ContractToTemplate", fields: [template_id], references: [id])
  addon_links            ContractAddonLink[]
  dresses                ContractDress[]
  sign_link              ContractSignLink?    @relation("ContractToSignLink")

  @@unique([contract_number, organization_id]) // Contract number unique per organization
  @@index([organization_id])
}

model ContractAddonLink {
  contract_id String
  addon_id    String
  addon       ContractAddon @relation(fields: [addon_id], references: [id])
  contract    Contract      @relation(fields: [contract_id], references: [id])

  @@id([contract_id, addon_id])
}

model ContractDress {
  id          String   @id @default(uuid())
  contract_id String
  dress_id    String
  created_at  DateTime @default(now())
  contract    Contract @relation(fields: [contract_id], references: [id])
  dress       Dress    @relation(fields: [dress_id], references: [id])
}

model PackageAddon {
  package_id String
  addon_id   String
  addon      ContractAddon   @relation(fields: [addon_id], references: [id])
  package    ContractPackage @relation(fields: [package_id], references: [id])

  @@id([package_id, addon_id])
}

model ContractSignLink {
  id          String   @id @default(uuid())
  contract_id String   @unique
  customer_id String
  token       String   @unique
  expires_at  DateTime
  contract    Contract @relation("ContractToSignLink", fields: [contract_id], references: [id])
  customer    Customer @relation(fields: [customer_id], references: [id])
}

model Notification {
  id         String                 @id @default(uuid())
  type       String
  title      String
  message    String?
  meta       Json?
  created_at DateTime               @default(now())
  userLinks  NotificationUserLink[]
}

model NotificationUserLink {
  id              String       @id @default(uuid())
  notification_id String
  user_id         String
  seen            Boolean      @default(false)
  seen_at         DateTime?
  notification    Notification @relation(fields: [notification_id], references: [id])
  user            User         @relation(fields: [user_id], references: [id])

  @@unique([notification_id, user_id])
}

model CustomerNote {
  id          String    @id @default(uuid())
  customer_id String
  content     String
  created_at  DateTime  @default(now())
  created_by  String?
  updated_at  DateTime? @updatedAt
  updated_by  String?
  deleted_at  DateTime?
  deleted_by  String?
  customer    Customer  @relation(fields: [customer_id], references: [id], onDelete: Cascade)
}

model ApiKey {
  id           String    @id @default(uuid())
  name         String // Ex: "E-commerce Frontend"
  key_hash     String    @unique // Hash de la clé (bcrypt)
  scopes       String // JSON array: ["read:dresses", "write:prospects", "write:customers"]
  expires_at   DateTime?
  last_used_at DateTime?
  created_at   DateTime  @default(now())
  created_by   String?
  revoked_at   DateTime?
  revoked_by   String?
}

// ============================================
// BUSINESS RULES MODELS
// ============================================

model PricingRule {
  id               String  @id @default(uuid())
  name             String // Ex: "Location journalière standard"
  organization_id  String? // null = global pricing rule
  contract_type_id String? // Lié à un type de contrat (optionnel)

  // Pricing Strategy
  strategy String // "per_day", "flat_rate", "fixed_price", "tiered"
  /**
   * - per_day: Prix total = prix_par_jour × nombre_de_jours
   * - flat_rate: Prix total = prix_par_jour (forfait période, ex: weekend)
   * - fixed_price: Prix total = forfait fixe défini
   * - tiered: Prix dégressif selon durée (ex: -10% après 7 jours)
   */

  // Configuration de calcul
  calculation_config Json?
  /**
   * Example for per_day:
   * {
   * "base_price_source": "dress", // "dress" | "contract" | "custom"
   * "apply_tax": true,
   * "tax_rate": 20,
   * "rounding": "up" // "up" | "down" | "nearest"
   * }
   * Example for tiered:
   * {
   * "tiers": [
   * { "min_days": 1, "max_days": 3, "discount_percentage": 0 },
   * { "min_days": 4, "max_days": 7, "discount_percentage": 10 },
   * { "min_days": 8, "max_days": null, "discount_percentage": 20 }
   * ]
   * }
   * Example for flat_rate:
   * {
   * "applies_to_period": "weekend", // "day" | "weekend" | "week" | "month"
   * "fixed_multiplier": 1.0
   * }
   * Example for fixed_price:
   * {
   * "fixed_amount_ht": 150.00,
   * "fixed_amount_ttc": 180.00
   * }
   */

  // Applicability rules
  applies_to Json? // Conditions d'application
  /**
   * Example:
   * {
   * "dress_types": ["robe_soiree", "robe_cocktail"],
   * "min_duration_days": 3,
   * "max_duration_days": null,
   * "customer_types": ["vip", "regular"]
   * }
   */

  priority  Int     @default(0) // Higher = higher priority
  is_active Boolean @default(true)

  created_at DateTime  @default(now())
  created_by String?
  updated_at DateTime? @updatedAt
  updated_by String?

  organization  Organization? @relation(fields: [organization_id], references: [id])
  contract_type ContractType? @relation(fields: [contract_type_id], references: [id])

  @@unique([name, organization_id])
  @@index([organization_id])
  @@index([contract_type_id])
  @@index([strategy])
  @@index([is_active])
  @@index([priority])
}

// ============================================
// SUBSCRIPTION & BILLING MODELS
// ============================================

model SubscriptionPlan {
  id          String  @id @default(uuid())
  name        String  @unique // "Free", "Basic", "Pro", "Enterprise"
  code        String  @unique // "free", "basic", "pro", "enterprise"
  description String?

  // Pricing
  price_monthly Decimal @default(0) // Prix mensuel HT
  price_yearly  Decimal @default(0) // Prix annuel HT (avec réduction)
  currency      String  @default("EUR")

  // Stripe Integration
  stripe_product_id       String? @unique // Stripe Product ID
  stripe_price_id_monthly String? @unique // Stripe Price ID for monthly billing
  stripe_price_id_yearly  String? @unique // Stripe Price ID for yearly billing

  // Trial
  trial_days Int @default(14) // Jours d'essai gratuit

  // Feature Limits (Quotas)
  limits Json // Limites du plan
  /**
   * Example limits:
   * {
   * "users": 5,                    // Max users
   * "dresses": 100,                // Max robes
   * "customers": 500,              // Max clients
   * "contracts_per_month": 50,     // Max contrats/mois
   * "storage_gb": 10,              // Stockage en GB
   * "api_calls_per_day": 1000,     // Appels API/jour
   * "custom_branding": false,      // Personnalisation
   * "advanced_pricing": false,     // Règles de pricing avancées
   * "multi_location": false,       // Multi-emplacements
   * "priority_support": false,     // Support prioritaire
   * "custom_reports": false,       // Rapports personnalisés
   * "integrations": ["basic"],     // Intégrations disponibles
   * "email_notifications": 100     // Emails/mois
   * }
   */

  // Features (Boolean flags)
  features Json // Fonctionnalités activées
  /**
   * Example features:
   * {
   * "prospect_management": true,
   * "contract_generation": true,
   * "electronic_signature": false,
   * "inventory_management": true,
   * "customer_portal": false,
   * "advanced_analytics": false,
   * "export_data": true,
   * "api_access": false,
   * "white_label": false,
   * "sms_notifications": false
   * }
   */

  // Display
  is_public  Boolean @default(true) // Visible sur la page pricing
  is_popular Boolean @default(false) // Badge "Populaire"
  sort_order Int     @default(0) // Ordre d'affichage

  created_at DateTime  @default(now())
  updated_at DateTime? @updatedAt

  // Relations
  organizations Organization[]

  @@index([code])
  @@index([is_public])
}

model UsageEvent {
  id              String @id @default(uuid())
  organization_id String

  // Event details
  event_type    String // "user_created", "dress_created", "contract_created", etc.
  resource_type String // "user", "dress", "contract", "api_call", etc.
  resource_id   String? // ID de la ressource concernée

  // Metadata
  metadata Json? // Données supplémentaires
  /**
   * Example:
   * {
   * "user_id": "uuid",
   * "action": "create",
   * "ip_address": "192.168.1.1",
   * "user_agent": "..."
   * }
   */

  // Aggregation fields (for efficient querying)
  event_date  DateTime @default(now()) // Date de l'événement
  event_month String // Format: "2025-12" (for monthly quotas)
  event_day   String // Format: "2025-12-06" (for daily quotas)

  created_at DateTime @default(now())

  organization Organization @relation(fields: [organization_id], references: [id])

  @@index([organization_id])
  @@index([event_type])
  @@index([resource_type])
  @@index([event_month])
  @@index([event_day])
  @@index([created_at])
}

// Audit Log for critical operations (RGPD compliance - 7 years retention)
model AuditLog {
  id              String   @id @default(uuid())
  organization_id String?
  user_id         String?

  // Action details
  action        String // "ACCOUNT_DELETION_REQUESTED", "ACCOUNT_DELETION_CONFIRMED", "ACCOUNT_DELETION_CANCELLED", etc.
  resource_type String? // "organization", "user", "contract", etc.
  resource_id   String? // ID of the affected resource

  // Context
  ip_address String?
  user_agent String?
  method     String? // HTTP method (POST, DELETE, etc.)
  endpoint   String? // API endpoint called

  // Result
  status        String // "SUCCESS", "FAILURE"
  error_message String? // Error details if status = FAILURE

  // Metadata (flexible JSON for additional context)
  metadata Json?
  /**
   * Example for account deletion:
   * {
   *   "validation_code": "123456",
   *   "user_role": "MANAGER",
   *   "user_email": "user@example.com",
   *   "organization_name": "My Company",
   *   "deletion_reason": "user_requested",
   *   "data_exported": true,
   *   "export_file_path": "/backups/org_xyz_20251220.zip"
   * }
   */

  // Timestamps
  created_at DateTime @default(now())
  retention_until DateTime // Auto-calculated: created_at + 7 years (RGPD compliance)

  // Note: No relations defined for organization_id and user_id
  // These are kept as simple string references for audit trail purposes
  // This prevents cascade deletes and maintains historical integrity

  @@index([organization_id])
  @@index([user_id])
  @@index([action])
  @@index([resource_type])
  @@index([status])
  @@index([created_at])
  @@index([retention_until]) // For automated cleanup after 7 years
}
